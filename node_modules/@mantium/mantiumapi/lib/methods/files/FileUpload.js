"use strict";

var config = require('../../config/config');

var msg = require('../../config/error-message');

var fetch = require('../fetch');

module.exports = function (headers, opt) {
  if (!headers.api_key) throw new Error(msg.errorMessages().access_token_missing);
  var key = opt.key,
      purpose = opt.purpose,
      upload_source = opt.upload_source,
      method = opt.method;
  if (!upload_source) throw new Error(msg.errorMessages().files.upload_source);
  delete opt.isIdURL; // internal use only

  var url = config.filesUploadURL();
  var options = {
    method: method,
    url: url,
    headers: headers.getHeaders()
  };
  options['body'] = JSON.stringify({
    fine_tune_file_type: opt.fine_tune_file_type,
    purpose: purpose,
    key: key.path.replace(/^.*[\\\/]/, ''),
    upload_source: upload_source
  });
  return fetch(options);
};